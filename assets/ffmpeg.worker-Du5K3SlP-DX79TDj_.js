var M=Object.defineProperty,_=t=>{throw TypeError(t)},O=(t,e,a)=>e in t?M(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a,h=(t,e,a)=>O(t,typeof e!="symbol"?e+"":e,a),b=(t,e,a)=>e.has(t)||_("Cannot "+a),s=(t,e,a)=>(b(t,e,"read from private field"),a?a.call(t):e.get(t)),f=(t,e,a)=>e.has(t)?_("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,a),y=(t,e,a,i)=>(b(t,e,"write to private field"),e.set(t,a),a),r;(function(t){t.LOAD="LOAD",t.EXEC="EXEC",t.WRITE_FILE="WRITE_FILE",t.READ_FILE="READ_FILE",t.DELETE_FILE="DELETE_FILE",t.RENAME="RENAME",t.CREATE_DIR="CREATE_DIR",t.LIST_DIR="LIST_DIR",t.DELETE_DIR="DELETE_DIR",t.ERROR="ERROR",t.DOWNLOAD="DOWNLOAD",t.PROGRESS="PROGRESS",t.LOG="LOG"})(r||(r={}));const S=(()=>{let t=0;return()=>t++})(),k=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),v=new Error("called FFmpeg.terminate()");var n,p,E,u,R,I,o;class W{constructor(){f(this,n,null),f(this,p,{}),f(this,E,{}),f(this,u,[]),f(this,R,[]),h(this,"loaded",!1),f(this,I,()=>{s(this,n)&&(s(this,n).onmessage=({data:{id:e,type:a,data:i}})=>{switch(a){case r.LOAD:this.loaded=!0,s(this,p)[e](i);break;case r.EXEC:case r.WRITE_FILE:case r.READ_FILE:case r.DELETE_FILE:case r.RENAME:case r.CREATE_DIR:case r.LIST_DIR:case r.DELETE_DIR:s(this,p)[e](i);break;case r.LOG:s(this,u).forEach(l=>l(i));break;case r.PROGRESS:s(this,R).forEach(l=>l(i));break;case r.ERROR:s(this,E)[e](i);break}delete s(this,p)[e],delete s(this,E)[e]})}),f(this,o,({type:e,data:a},i=[])=>s(this,n)?new Promise((l,w)=>{const d=S();s(this,n)&&s(this,n).postMessage({id:d,type:e,data:a},i),s(this,p)[d]=l,s(this,E)[d]=w}):Promise.reject(k)),h(this,"load",(e={})=>(s(this,n)||(y(this,n,new Worker(new URL("/assets/worker-D58qJ3c2-DzIa2k1D.js",import.meta.url),{type:"module"})),s(this,I).call(this)),s(this,o).call(this,{type:r.LOAD,data:e}))),h(this,"exec",(e,a=-1)=>s(this,o).call(this,{type:r.EXEC,data:{args:e,timeout:a}})),h(this,"terminate",()=>{const e=Object.keys(s(this,E));for(const a of e)s(this,E)[a](v),delete s(this,E)[a],delete s(this,p)[a];s(this,n)&&(s(this,n).terminate(),y(this,n,null),this.loaded=!1)}),h(this,"writeFile",(e,a)=>{const i=[];return a instanceof Uint8Array&&i.push(a.buffer),s(this,o).call(this,{type:r.WRITE_FILE,data:{path:e,data:a}},i)}),h(this,"readFile",(e,a="binary")=>s(this,o).call(this,{type:r.READ_FILE,data:{path:e,encoding:a}})),h(this,"deleteFile",e=>s(this,o).call(this,{type:r.DELETE_FILE,data:{path:e}})),h(this,"rename",(e,a)=>s(this,o).call(this,{type:r.RENAME,data:{oldPath:e,newPath:a}})),h(this,"createDir",e=>s(this,o).call(this,{type:r.CREATE_DIR,data:{path:e}})),h(this,"listDir",e=>s(this,o).call(this,{type:r.LIST_DIR,data:{path:e}})),h(this,"deleteDir",e=>s(this,o).call(this,{type:r.DELETE_DIR,data:{path:e}}))}on(e,a){e==="log"?s(this,u).push(a):e==="progress"&&s(this,R).push(a)}off(e,a){e==="log"?y(this,u,s(this,u).filter(i=>i!==a)):e==="progress"&&y(this,R,s(this,R).filter(i=>i!==a))}}n=new WeakMap,p=new WeakMap,E=new WeakMap,u=new WeakMap,R=new WeakMap,I=new WeakMap,o=new WeakMap;const C=t=>new Promise((e,a)=>{const i=new FileReader;i.onload=()=>{const{result:l}=i;l instanceof ArrayBuffer?e(new Uint8Array(l)):e(new Uint8Array)},i.onerror=l=>{a(Error(`File could not be read! Code=${l?.target?.error?.code||-1}`))},i.readAsArrayBuffer(t)}),P=async t=>{let e;if(typeof t=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(t)?e=atob(t.split(",")[1]).split("").map(a=>a.charCodeAt(0)):e=await(await fetch(t)).arrayBuffer();else if(t instanceof URL)e=await(await fetch(t)).arrayBuffer();else if(t instanceof File||t instanceof Blob)e=await C(t);else return new Uint8Array;return new Uint8Array(e)};let c=null,m=!1;function x(t){switch(t){case"low":return{dither:"bayer:bayer_scale=5",scaleFlags:"bilinear"};case"high":return{dither:"sierra2_4a",scaleFlags:"lanczos"};default:return{dither:"floyd_steinberg",scaleFlags:"bicubic"}}}async function $(){if(c)return c;if(m){for(;!c;)await new Promise(t=>setTimeout(t,50));return c}m=!0,c=new W,c.on("progress",({progress:t})=>{self.postMessage({ratio:Math.max(0,Math.min(1,t))})});try{await c.load()}finally{m=!1}return c}self.addEventListener("message",async t=>{const{type:e,payload:a}=t.data||{};if(e!=="encode")return;const i=a;try{const l=await $(),w="input.mp4",d="palette.png",g="output.gif",D=Math.max(0,Math.min(i.startSec,i.endSec-.1)),F=Math.max(.1,i.endSec-D),L=x(i.quality);await l.writeFile(w,await P(new Blob([i.file]))),await l.exec(["-ss",String(D),"-t",String(F),"-i",w,"-vf",`fps=${i.fps},scale=${i.width}:-1:flags=${L.scaleFlags},palettegen`,d]);const T=i.loop?"0":"1";await l.exec(["-ss",String(D),"-t",String(F),"-i",w,"-i",d,"-lavfi",`fps=${i.fps},scale=${i.width}:-1:flags=${L.scaleFlags} [x]; [x][1:v] paletteuse=dither=${L.dither}`,"-loop",T,g]);const A=await l.readFile(g);self.postMessage({type:"done",data:A},[A.buffer]);try{await l.deleteFile(w),await l.deleteFile(d),await l.deleteFile(g)}catch{}}catch(l){self.postMessage({ratio:1,message:l?.message||"encode failed"})}});
