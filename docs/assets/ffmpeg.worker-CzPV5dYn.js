var C=Object.defineProperty;var T=t=>{throw TypeError(t)};var U=(t,e,a)=>e in t?C(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a;var l=(t,e,a)=>U(t,typeof e!="symbol"?e+"":e,a),$=(t,e,a)=>e.has(t)||T("Cannot "+a);var r=(t,e,a)=>($(t,e,"read from private field"),a?a.call(t):e.get(t)),h=(t,e,a)=>e.has(t)?T("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,a),D=(t,e,a,s)=>($(t,e,"write to private field"),s?s.call(t,a):e.set(t,a),a);var i;(function(t){t.LOAD="LOAD",t.EXEC="EXEC",t.WRITE_FILE="WRITE_FILE",t.READ_FILE="READ_FILE",t.DELETE_FILE="DELETE_FILE",t.RENAME="RENAME",t.CREATE_DIR="CREATE_DIR",t.LIST_DIR="LIST_DIR",t.DELETE_DIR="DELETE_DIR",t.ERROR="ERROR",t.DOWNLOAD="DOWNLOAD",t.PROGRESS="PROGRESS",t.LOG="LOG"})(i||(i={}));const N=(()=>{let t=0;return()=>t++})(),W=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),B=new Error("called FFmpeg.terminate()");var o,R,E,u,m,L,c;class P{constructor(){h(this,o,null);h(this,R,{});h(this,E,{});h(this,u,[]);h(this,m,[]);l(this,"loaded",!1);h(this,L,()=>{r(this,o)&&(r(this,o).onmessage=({data:{id:e,type:a,data:s}})=>{switch(a){case i.LOAD:this.loaded=!0,r(this,R)[e](s);break;case i.EXEC:case i.WRITE_FILE:case i.READ_FILE:case i.DELETE_FILE:case i.RENAME:case i.CREATE_DIR:case i.LIST_DIR:case i.DELETE_DIR:r(this,R)[e](s);break;case i.LOG:r(this,u).forEach(n=>n(s));break;case i.PROGRESS:r(this,m).forEach(n=>n(s));break;case i.ERROR:r(this,E)[e](s);break}delete r(this,R)[e],delete r(this,E)[e]})});h(this,c,({type:e,data:a},s=[])=>r(this,o)?new Promise((n,w)=>{const p=N();r(this,o)&&r(this,o).postMessage({id:p,type:e,data:a},s),r(this,R)[p]=n,r(this,E)[p]=w}):Promise.reject(W));l(this,"load",(e={})=>(r(this,o)||(D(this,o,new Worker(new URL(""+new URL("worker-D58qJ3c2.js",import.meta.url).href,import.meta.url),{type:"module"})),r(this,L).call(this)),r(this,c).call(this,{type:i.LOAD,data:e})));l(this,"exec",(e,a=-1)=>r(this,c).call(this,{type:i.EXEC,data:{args:e,timeout:a}}));l(this,"terminate",()=>{const e=Object.keys(r(this,E));for(const a of e)r(this,E)[a](B),delete r(this,E)[a],delete r(this,R)[a];r(this,o)&&(r(this,o).terminate(),D(this,o,null),this.loaded=!1)});l(this,"writeFile",(e,a)=>{const s=[];return a instanceof Uint8Array&&s.push(a.buffer),r(this,c).call(this,{type:i.WRITE_FILE,data:{path:e,data:a}},s)});l(this,"readFile",(e,a="binary")=>r(this,c).call(this,{type:i.READ_FILE,data:{path:e,encoding:a}}));l(this,"deleteFile",e=>r(this,c).call(this,{type:i.DELETE_FILE,data:{path:e}}));l(this,"rename",(e,a)=>r(this,c).call(this,{type:i.RENAME,data:{oldPath:e,newPath:a}}));l(this,"createDir",e=>r(this,c).call(this,{type:i.CREATE_DIR,data:{path:e}}));l(this,"listDir",e=>r(this,c).call(this,{type:i.LIST_DIR,data:{path:e}}));l(this,"deleteDir",e=>r(this,c).call(this,{type:i.DELETE_DIR,data:{path:e}}))}on(e,a){e==="log"?r(this,u).push(a):e==="progress"&&r(this,m).push(a)}off(e,a){e==="log"?D(this,u,r(this,u).filter(s=>s!==a)):e==="progress"&&D(this,m,r(this,m).filter(s=>s!==a))}}o=new WeakMap,R=new WeakMap,E=new WeakMap,u=new WeakMap,m=new WeakMap,L=new WeakMap,c=new WeakMap;const j=t=>new Promise((e,a)=>{const s=new FileReader;s.onload=()=>{const{result:n}=s;n instanceof ArrayBuffer?e(new Uint8Array(n)):e(new Uint8Array)},s.onerror=n=>{a(Error(`File could not be read! Code=${n?.target?.error?.code||-1}`))},s.readAsArrayBuffer(t)}),v=async t=>{let e;if(typeof t=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(t)?e=atob(t.split(",")[1]).split("").map(a=>a.charCodeAt(0)):e=await(await fetch(t)).arrayBuffer();else if(t instanceof URL)e=await(await fetch(t)).arrayBuffer();else if(t instanceof File||t instanceof Blob)e=await j(t);else return new Uint8Array;return new Uint8Array(e)};let d=null,_=!1;function G(t){switch(t){case"low":return{dither:"bayer:bayer_scale=5",scaleFlags:"bilinear"};case"high":return{dither:"sierra2_4a",scaleFlags:"lanczos"};default:return{dither:"floyd_steinberg",scaleFlags:"bicubic"}}}async function M(){if(d)return d;if(_){for(;!d;)await new Promise(t=>setTimeout(t,50));return d}_=!0,d=new P,d.on("progress",({progress:t})=>{self.postMessage({ratio:Math.max(0,Math.min(1,t))})});try{await d.load({coreURL:"https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm/ffmpeg-core.js",wasmURL:"https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm/ffmpeg-core.wasm"})}catch(t){throw console.error("FFmpeg load failed:",t),t}finally{_=!1}return d}self.addEventListener("message",async t=>{const{type:e,payload:a}=t.data||{};if(e!=="encode")return;const s=a;try{const n=await M(),w="input.mp4",p="palette.png",I="output.gif",g=Math.max(0,Math.min(s.startSec,s.endSec-.1)),y=Math.max(.1,s.endSec-g),A=G(s.quality);await n.writeFile(w,await v(new Blob([s.file]))),await n.exec(["-ss",String(g),"-t",String(y),"-i",w,"-vf",`fps=${s.fps},scale=${s.width}:-1:flags=${A.scaleFlags},palettegen`,p]);const k=s.loop?"0":"1";let O="";if(s.textOverlays&&s.textOverlays.length>0){const S=s.textOverlays.map((f,z)=>{const x=Math.max(0,f.startTime-g),F=Math.min(y,f.endTime-g);return F-x<=0?"":`drawtext=text='${f.text.replace(/'/g,"\\'")}':fontfile=/System/Library/Fonts/Arial.ttf:fontsize=${f.fontSize}:fontcolor=${f.color}:x=${f.x}*W/100:y=${f.y}*H/100:enable='between(t,${x},${F})'`}).filter(f=>f).join(",");S&&(O=`,${S}`)}await n.exec(["-ss",String(g),"-t",String(y),"-i",w,"-i",p,"-lavfi",`fps=${s.fps},scale=${s.width}:-1:flags=${A.scaleFlags}${O} [x]; [x][1:v] paletteuse=dither=${A.dither}`,"-loop",k,I]);const b=await n.readFile(I);self.postMessage({type:"done",data:b},[b.buffer]);try{await n.deleteFile(w),await n.deleteFile(p),await n.deleteFile(I)}catch{}}catch(n){self.postMessage({type:"error",message:n?.message||"encode failed"})}});
