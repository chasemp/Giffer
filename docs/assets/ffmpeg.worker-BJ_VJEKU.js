var F=Object.defineProperty;var O=t=>{throw TypeError(t)};var T=(t,e,a)=>e in t?F(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a;var o=(t,e,a)=>T(t,typeof e!="symbol"?e+"":e,a),b=(t,e,a)=>e.has(t)||O("Cannot "+a);var s=(t,e,a)=>(b(t,e,"read from private field"),a?a.call(t):e.get(t)),f=(t,e,a)=>e.has(t)?O("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,a),D=(t,e,a,i)=>(b(t,e,"write to private field"),i?i.call(t,a):e.set(t,a),a);var r;(function(t){t.LOAD="LOAD",t.EXEC="EXEC",t.WRITE_FILE="WRITE_FILE",t.READ_FILE="READ_FILE",t.DELETE_FILE="DELETE_FILE",t.RENAME="RENAME",t.CREATE_DIR="CREATE_DIR",t.LIST_DIR="LIST_DIR",t.DELETE_DIR="DELETE_DIR",t.ERROR="ERROR",t.DOWNLOAD="DOWNLOAD",t.PROGRESS="PROGRESS",t.LOG="LOG"})(r||(r={}));const C=(()=>{let t=0;return()=>t++})(),k=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),N=new Error("called FFmpeg.terminate()");var l,d,E,u,p,L,c;class x{constructor(){f(this,l,null);f(this,d,{});f(this,E,{});f(this,u,[]);f(this,p,[]);o(this,"loaded",!1);f(this,L,()=>{s(this,l)&&(s(this,l).onmessage=({data:{id:e,type:a,data:i}})=>{switch(a){case r.LOAD:this.loaded=!0,s(this,d)[e](i);break;case r.EXEC:case r.WRITE_FILE:case r.READ_FILE:case r.DELETE_FILE:case r.RENAME:case r.CREATE_DIR:case r.LIST_DIR:case r.DELETE_DIR:s(this,d)[e](i);break;case r.LOG:s(this,u).forEach(n=>n(i));break;case r.PROGRESS:s(this,p).forEach(n=>n(i));break;case r.ERROR:s(this,E)[e](i);break}delete s(this,d)[e],delete s(this,E)[e]})});f(this,c,({type:e,data:a},i=[])=>s(this,l)?new Promise((n,w)=>{const R=C();s(this,l)&&s(this,l).postMessage({id:R,type:e,data:a},i),s(this,d)[R]=n,s(this,E)[R]=w}):Promise.reject(k));o(this,"load",(e={})=>(s(this,l)||(D(this,l,new Worker(new URL(""+new URL("worker-D58qJ3c2.js",import.meta.url).href,import.meta.url),{type:"module"})),s(this,L).call(this)),s(this,c).call(this,{type:r.LOAD,data:e})));o(this,"exec",(e,a=-1)=>s(this,c).call(this,{type:r.EXEC,data:{args:e,timeout:a}}));o(this,"terminate",()=>{const e=Object.keys(s(this,E));for(const a of e)s(this,E)[a](N),delete s(this,E)[a],delete s(this,d)[a];s(this,l)&&(s(this,l).terminate(),D(this,l,null),this.loaded=!1)});o(this,"writeFile",(e,a)=>{const i=[];return a instanceof Uint8Array&&i.push(a.buffer),s(this,c).call(this,{type:r.WRITE_FILE,data:{path:e,data:a}},i)});o(this,"readFile",(e,a="binary")=>s(this,c).call(this,{type:r.READ_FILE,data:{path:e,encoding:a}}));o(this,"deleteFile",e=>s(this,c).call(this,{type:r.DELETE_FILE,data:{path:e}}));o(this,"rename",(e,a)=>s(this,c).call(this,{type:r.RENAME,data:{oldPath:e,newPath:a}}));o(this,"createDir",e=>s(this,c).call(this,{type:r.CREATE_DIR,data:{path:e}}));o(this,"listDir",e=>s(this,c).call(this,{type:r.LIST_DIR,data:{path:e}}));o(this,"deleteDir",e=>s(this,c).call(this,{type:r.DELETE_DIR,data:{path:e}}))}on(e,a){e==="log"?s(this,u).push(a):e==="progress"&&s(this,p).push(a)}off(e,a){e==="log"?D(this,u,s(this,u).filter(i=>i!==a)):e==="progress"&&D(this,p,s(this,p).filter(i=>i!==a))}}l=new WeakMap,d=new WeakMap,E=new WeakMap,u=new WeakMap,p=new WeakMap,L=new WeakMap,c=new WeakMap;const U=t=>new Promise((e,a)=>{const i=new FileReader;i.onload=()=>{const{result:n}=i;n instanceof ArrayBuffer?e(new Uint8Array(n)):e(new Uint8Array)},i.onerror=n=>{a(Error(`File could not be read! Code=${n?.target?.error?.code||-1}`))},i.readAsArrayBuffer(t)}),$=async t=>{let e;if(typeof t=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(t)?e=atob(t.split(",")[1]).split("").map(a=>a.charCodeAt(0)):e=await(await fetch(t)).arrayBuffer();else if(t instanceof URL)e=await(await fetch(t)).arrayBuffer();else if(t instanceof File||t instanceof Blob)e=await U(t);else return new Uint8Array;return new Uint8Array(e)};let h=null,_=!1;function B(t){switch(t){case"low":return{dither:"bayer:bayer_scale=5",scaleFlags:"bilinear"};case"high":return{dither:"sierra2_4a",scaleFlags:"lanczos"};default:return{dither:"floyd_steinberg",scaleFlags:"bicubic"}}}async function P(){if(h)return h;if(_){for(;!h;)await new Promise(t=>setTimeout(t,50));return h}_=!0,h=new x,h.on("progress",({progress:t})=>{self.postMessage({ratio:Math.max(0,Math.min(1,t))})});try{await h.load()}finally{_=!1}return h}self.addEventListener("message",async t=>{const{type:e,payload:a}=t.data||{};if(e!=="encode")return;const i=a;try{const n=await P(),w="input.mp4",R="palette.png",g="output.gif",I=Math.max(0,Math.min(i.startSec,i.endSec-.1)),A=Math.max(.1,i.endSec-I),m=B(i.quality);await n.writeFile(w,await $(new Blob([i.file]))),await n.exec(["-ss",String(I),"-t",String(A),"-i",w,"-vf",`fps=${i.fps},scale=${i.width}:-1:flags=${m.scaleFlags},palettegen`,R]);const S=i.loop?"0":"1";await n.exec(["-ss",String(I),"-t",String(A),"-i",w,"-i",R,"-lavfi",`fps=${i.fps},scale=${i.width}:-1:flags=${m.scaleFlags} [x]; [x][1:v] paletteuse=dither=${m.dither}`,"-loop",S,g]);const y=await n.readFile(g);self.postMessage({type:"done",data:y},[y.buffer]);try{await n.deleteFile(w),await n.deleteFile(R),await n.deleteFile(g)}catch{}}catch(n){self.postMessage({ratio:1,message:n?.message||"encode failed"})}});
